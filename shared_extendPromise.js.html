<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8" />
    <title>shared/extendPromise.js - wootils docs</title>
    
    
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/prettify.css" />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css" />
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no" />
    <link rel="shortcut icon" href="icons/favicon-48.png" />
    <link rel="apple-touch-icon" sizes="48x48" href="icons/favicon-48.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="icons/favicon-72.png" />
    <link rel="apple-touch-icon" sizes="96x96" href="icons/favicon-96.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="icons/favicon-144.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icons/favicon-192.png" />
    <link rel="apple-touch-icon" sizes="256x256" href="icons/favicon-256.png" />
    <link rel="apple-touch-icon" sizes="384x384" href="icons/favicon-384.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="icons/favicon-512.png" />
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html" class="home-link">wootils</a></h2><ul class="ref-links">
            <li><a
                class="ref-link -yarn"
                title="View the package on Yarn"
                href="https://yarnpkg.com/package/wootils"
                target="_blank"
            >View the package on Yarn</a></li>
        

            <li><a
                class="ref-link -github"
                title="Go to the GitHub repository"
                href="https://github.com/homer0/wootils"
                target="_blank"
            >Go to the GitHub repository</a></li>
        

            <li><a
                class="ref-link -npm"
                title="View the package on NPM"
                href="https://www.npmjs.com/package/wootils"
                target="_blank"
            >View the package on NPM</a></li>
        </ul><h3>Modules</h3><ul><li><a href="module-browser_simpleStorage.html">browser/simpleStorage</a></li><li><a href="module-node_appConfiguration.html">node/appConfiguration</a></li><li><a href="module-node_environmentUtils.html">node/environmentUtils</a></li><li><a href="module-node_errorHandler.html">node/errorHandler</a></li><li><a href="module-node_logger.html">node/logger</a></li><li><a href="module-node_packageInfo.html">node/packageInfo</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-node_packageInfo.html#~packageInfo">packageInfo</a></li></ul></li><li><a href="module-node_pathUtils.html">node/pathUtils</a></li><li><a href="module-node_rootRequire.html">node/rootRequire</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-node_rootRequire.html#~rootRequire">rootRequire</a></li></ul></li><li><a href="module-shared_apiClient.html">shared/apiClient</a></li><li><a href="module-shared_deepAssign.html">shared/deepAssign</a></li><li><a href="module-shared_deferred.html">shared/deferred</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-shared_deferred.html#.deferred">deferred</a></li></ul></li><li><a href="module-shared_eventsHub.html">shared/eventsHub</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-shared_eventsHub.html#~wrapper">wrapper</a></li></ul></li><li><a href="module-shared_extendPromise.html">shared/extendPromise</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-shared_extendPromise.html#~apply">apply</a></li><li data-type='method' style='display: none;'><a href="module-shared_extendPromise.html#~extendPromise">extendPromise</a></li><li data-type='method' style='display: none;'><a href="module-shared_extendPromise.html#~get">get</a></li></ul></li><li><a href="module-shared_jimpleFns.html">shared/jimpleFns</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-shared_jimpleFns.html#~provider">provider</a></li><li data-type='method' style='display: none;'><a href="module-shared_jimpleFns.html#~providerCreator">providerCreator</a></li><li data-type='method' style='display: none;'><a href="module-shared_jimpleFns.html#~proxyContainer">proxyContainer</a></li><li data-type='method' style='display: none;'><a href="module-shared_jimpleFns.html#~resource">resource</a></li><li data-type='method' style='display: none;'><a href="module-shared_jimpleFns.html#~resourceCreator">resourceCreator</a></li><li data-type='method' style='display: none;'><a href="module-shared_jimpleFns.html#~resourcesCollection">resourcesCollection</a></li></ul></li><li><a href="module-shared_objectUtils.html">shared/objectUtils</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-browser.html">Browser utilities</a></li><li><a href="tutorial-node.html">Node utilities</a></li><li><a href="tutorial-shared.html">Shared utilities</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">shared/extendPromise.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module shared/extendPromise
 */

/**
 * Helper class that creates a proxy for a {@link Promise} in order to add custom properties.
 *
 * The only reason this class exists is so it can "scope" the necessary methods to extend
 * {@link Promise} and avoid workarounds in order to declare them, as they need to call
 * themselves recursively.
 *
 * @parent module:shared/extendPromise
 * @tutorial extendPromise
 */
class PromiseExtender {
  /**
   * @param {Promise}           promise    The promise to extend.
   * @param {Object.&lt;string,*>} properties A dictionary of custom properties to _inject_ in the
   *                                       promise chain.
   */
  constructor(promise, properties) {
    /**
     * The proxied promise.
     *
     * @type {Proxy&lt;Promise>}
     * @access private
     * @ignore
     */
    this._promise = this._extend(promise, properties);
  }
  /**
   * The extended promise.
   *
   * @type {Proxy&lt;Promise>}
   */
  get promise() {
    return this._promise;
  }
  /**
   * The method that actually extends a promise: it creates a proxy of the promise in order to
   * intercept the getters so it can return the custom properties if requested, and return new
   * proxies when `then`, `catch` and `finally` are called; the reason new proxies are created
   * is because those methods return new promises, and without being proxied, the custom
   * properties would be lost.
   *
   * @param {Promise} promise    The promise to proxy.
   * @param {Object}  properties A dictionary of custom properties to _inject_ in the promise
   *                             chain.
   * @returns {Proxy&lt;Promise>}
   * @throws {Error} If `promise` is not a valid instance of {@link Promise}.
   * @throws {Error} If `properties` is not an object or if it doesn't have any properties.
   * @access private
   * @ignore
   */
  _extend(promise, properties) {
    if (!(promise instanceof Promise)) {
      throw new Error('\'promise\' must be a valid Promise instance');
    } else if (!properties || !Object.keys(properties).length) {
      throw new Error('\'properties\' must be an object with at least one key');
    }

    return new Proxy(promise, {
      /**
       * This is a trap for when something is trying to read/access a property for the promise.
       * The function first validates if it's one of the functions (`then`/`catch`/`finally`) in
       * order to return a proxied function; then, if it's another function (one that doesn't
       * return another promise), it just calls the original; finally, before doing a fallback to
       * the original promise, it checks if it's one of the custom properties that exented the
       * promise.
       *
       * @param {Promise} target The original promise.
       * @param {string}  name   The name of the property.
       * @returns {*}
       */
      get: (target, name) => {
        let result;
        if (['then', 'catch', 'finally'].includes(name)) {
          result = this._extendFunction(target[name].bind(target), properties);
        } else if (target[name] &amp;&amp; typeof target[name].bind === 'function') {
          result = target[name].bind(target);
        } else if (properties[name]) {
          result = properties[name];
        } else {
          result = target[name];
        }

        return result;
      },
    });
  }
  /**
   * Creates a proxy for a promise function (`then`/`catch`/`finally`) so the returned promise
   * can also be extended.
   *
   * @param {Function} fn         The promise function to proxy.
   * @param {Object}   properties A dictionary of custom properties to _inject_ in the promise
   *                              chain.
   * @returns {Proxy&lt;Function>}
   * @access private
   * @ignore
   */
  _extendFunction(fn, properties) {
    return new Proxy(fn, {
      /**
       * This is a trap for when a function gets called (remember this gets used for `then`/
       * `catch`/`finally`); it processes the result using the oringinal function and since promise
       * methods return a promise, instead of returning the original result, it returns an
       * _extended_ version of it.
       *
       * @param {Function} target  The original function.
       * @param {Promise}  thisArg The promise the function belongs to.
       * @param {Array}    args    The list of arguments sent to the trap.
       * @returns {Promise}
       */
      apply: (target, thisArg, args) => {
        const value = target.bind(thisArg)(...args);
        return this._extend(value, properties);
      },
    });
  }
}

/**
 * Extends a {@link Promise} by injecting custom properties using a {@link Proxy}. The custom
 * properties will be available on the promise chain no matter how many `then`s, `catch`s or
 * `finally`s are added.
 *
 * @param {Promise} promise    The promise to extend.
 * @param {Object}  properties A dictionary of custom properties to _inject_ in the promise
 *                             chain.
 * @throws {Error} If `promise` is not a valid instance of {@link Promise}.
 * @throws {Error} If `properties` is not an object or if it doesn't have any properties.
 * @returns {Proxy&lt;Promise>}
 * @tutorial extendPromise
 */
const extendPromise = (
  promise,
  properties,
) => (new PromiseExtender(promise, properties)).promise;

module.exports = extendPromise;
</code></pre>
        </article>
    </section>





    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.5</a> using a forked <a href="https://github.com/homer0/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
